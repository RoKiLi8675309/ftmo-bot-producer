# =============================================================================
# config.yaml â€“ PROJECT PHOENIX V16.23 (GOLDEN BASKET OPTIMIZATION)
# STATUS: LIVE TRADING | TARGET: PASS FTMO CHALLENGE (10% / 90 DAYS)
#
# REMEDIATION UPDATE (PORTFOLIO ROTATION):
# 1. GOLDEN BASKET: Shifted to High-Liquidity/Low-Spread Majors + JPY Crosses.
# 2. BLACKLIST: Removed GBPAUD/GBPNZD due to poor Spread-to-Vol ratio.
# 3. SAFETY: Enforced Max Currency Exposure of 2 to prevent USD stacking.
# =============================================================================

# --- ENVIRONMENT SPECIFIC ---
env:
  initial_balance: 50000.0
  mode: "LIVE" # Options: RESEARCH, PAPER, LIVE

# --- LOGGING CONFIGURATION ---
logging:
  level: "INFO"
  file_path: "ftmo_bot.log"
  max_size_mb: 10
  backup_count: 5
  human_friendly: true
  trade_audit_file: "trade_audit.jsonl"

# --- BROKER CONNECTION ---
mt5:
  login: null 
  password: null
  server: "FTMO-Server"
  path: "C:\\Program Files\\FTMO MetaTrader 5\\terminal64.exe"
  timeout_seconds: 5

# --- INFRASTRUCTURE ---
redis:
  host: "localhost"
  port: 6379
  db: 0
  price_data_stream: "price_data_stream"
  candle_stream_key_prefix: "stream:new_candle"
  trade_request_stream: "trade_requests"
  closed_trade_stream_key: "stream:closed_trades"
  account_info_key: "account:info"
  position_state_key_prefix: "positions"
  monitor_features_prefix: "monitor:features:"
  engine_state_key: 'bot:engine_state'
  
  risk_keys:
    current_equity: "risk:current_equity"
    daily_drawdown: "risk:daily_dd"
    open_positions: "risk:positions"
    daily_pnl: "risk:daily_pnl"
    consecutive_losses: "risk:consecutive_losses"
    last_deal_time: "risk:last_deal_time"
    pause_trading_flag: "risk:pause_trading"
    daily_starting_equity: "risk:daily_starting_equity"
    kill_switch_active: "bot:state:kill_switch_active"
    midnight_freeze: "risk:midnight_freeze"
    last_reset_date: "risk:last_reset_date"
    penalty_box_prefix: "risk:penalty_box:"
  
  heartbeat_key: "producer:heartbeat"

postgres:
  dsn: "postgresql://postgres:password@localhost:5432/trading_bot"

# --- PRODUCER SETTINGS ---
producer:
  tick_interval_seconds: 0.1
  process_priority: "HIGH"
  midnight_freeze_seconds: 300
  d1_update_interval: 60

# --- DATA SETTINGS ---
data:
  sampling_method: "imbalance" # Adaptive Imbalance Bars
  volume_bar_threshold: 10.0        
  imbalance_alpha: 0.05        # EWMA Forgetting Factor
  use_tick_rule: true
  download_start_date: "2023-01-01" 
  num_candles_producer: 50000
  num_candles_train: 10000000  # 10M Ticks
  num_candles_wfo: 10000
  num_candles_backtest: 1000000 # 1M Ticks

# --- FEATURE ENGINEERING ---
features:
  use_causal_features: true
  n_jobs: 20
  use_cache: true
  window_size: 50
  
  # Core Inputs
  use_log_returns: true
  
  # Project Phoenix L1 Proxies
  use_parkinson_vol: true               
  use_amihud_liquidity: true 
  use_relative_volume: true               
  use_aggressor_ratio: true               
  
  # Regime Filters (Anti-Chop)
  use_choppiness: true
  use_vortex: true
  
  # Legacy / Context
  use_regime: true
  use_vol_breakout: true
  
  # Indicator Windows
  rsi_period: 14
  macd_fast: 12
  macd_slow: 26
  macd_signal: 9
  atr_period: 14
  
  # Regime Settings
  choppiness:
    period: 14
    threshold: 60.0 
  vortex:
    period: 14
  
  # Context Windows
  d1_ema_period: 200
  entropy_window: 100
  entropy_threshold: 0.90
  
  # Stationarity
  fractional_differentiation:
    d: 0.4
    window: 30
    
  # Regime Filter (ADX)
  adx:
    period: 14
    threshold: 10.0 # RELAXED to 10.0 for Scalping
  
  cyclical_time: true
  session_awareness: true
  cluster_context: true
  d1_context: true

# --- PHOENIX STRATEGY PARAMETERS ---
phoenix_strategy:
  # --- ASSET REGIME MAPPING ---
  # V16.6: DISABLED to allow ML to decide best action (Trend vs Reversion)
  regime_enforcement: "DISABLED" 
  
  asset_regime_map:
    GBPJPY: "TREND_BREAKOUT" 
    USDJPY: "TREND_BREAKOUT"
    GBPUSD: "TREND_BREAKOUT"
    EURUSD: "NEUTRAL"
    AUDUSD: "NEUTRAL"
    USDCAD: "MEAN_REVERSION" # CAD often mean reverts on Oil
    EURJPY: "TREND_BREAKOUT"
    AUDJPY: "TREND_BREAKOUT"
    CAD: "NEUTRAL"    
    CHF: "NEUTRAL"    
    USD: "NEUTRAL"

  # --- STRUCTURAL GATES ---
  enable_regime_a_entries: true           
  require_d1_trend: false                          
  require_h4_alignment: false                  
  
  # --- LOGIC MAPPING THRESHOLDS (V16.3 TUNING) ---
  hurst_breakout_threshold: 0.42      # Relaxed from 0.45 to catch GBP moves
  hurst_mean_reversion_threshold: 0.00    
  ker_trend_threshold: 0.001          # Relaxed from 0.002
  
  bb_std_dev: 1.0                     # Relaxed from 1.2 to trigger more signals
  
  rvol_volatility_trigger: 2.5        
  
  # --- FILTER THRESHOLDS ---
  max_relative_volume: 25.0        
  volume_gate_ratio: 0.8            
  aggressor_threshold: 0.51        
  ml_confirmation_threshold: 0.55  
  choppiness_threshold: 65.0        
  
  # Microstructure Filters (Proxies)
  vpin_bucket_size: 1000
  vpin_threshold: 0.90
  gate_fdi_threshold: 1.60        

# --- OPTIMIZATION SEARCH SPACE (OPTUNA) ---
optimization_search_space:
  # River Model Params
  n_models:
    min: 30
    max: 50
    step: 5
  grace_period:
    min: 200
    max: 600
    step: 50
  delta:
    min: 1.0e-6
    max: 1.0e-4
    log: true
  lambda_value:
    min: 6
    max: 15
    step: 1
  
  # Filters & Gates
  entropy_threshold:
    min: 0.85
    max: 0.95
  vpin_threshold:
    min: 0.85 
    max: 0.95
  
  # Triple Barrier Method (Labeling)
  tbm_barrier_width:
    min: 1.5  # Tighter for scalping
    max: 3.5  
  tbm_horizon_minutes:
    min: 60   # 1 Hour
    max: 360  # 6 Hours
    step: 30
  tbm_drift_threshold:
    min: 1.0
    max: 2.0
  
  # Strategy Execution
  min_calibrated_probability:
    min: 0.00 
    max: 0.01

# --- RISK MANAGEMENT (FTMO COMPLIANCE) ---
risk_management:
  account_currency: "USD"
  
  # --- SIZING METHOD: AGGRESSOR PROTOCOL ---
  sizing_method: "fixed_risk"
  
  # V16.5 UPGRADE: 0.5% BASE RISK (Confirmed safe by 4.4% Max DD)
  base_risk_per_trade_percent: 0.0050
  
  # PROFIT BUFFER LOGIC
  profit_buffer_threshold: 0.02
  # Scaled risk 1.0% max (Hot Hand)
  scaled_risk_percent: 0.010
  
  # REVENGE TRADING GUARD
  loss_cooldown_minutes: 60  # Lock symbol for 1 hour after a loss
  
  # MARGIN LEVEL GATE (V16.11 NEW)
  min_margin_level_percent: 150.0

  # PYRAMIDING (COMPOUNDING)
  pyramiding:
    enabled: true
    max_adds: 2
    add_on_profit_r: 0.5  
    risk_per_add_percent: 0.0025 # Keep adds conservative
  
  # EQUITY RATCHET
  equity_ratchet:
    enabled: true
    step_percent: 0.05    # Lock floor every 5% gain
  
  # LIMITS
  max_daily_loss_pct: 0.040        # 4.0% Daily Limit (Buffer against 5.0%)
  max_total_loss_pct: 0.095        
  
  # PORTFOLIO HEAT
  # Strict limit: Only 2 pairs of the same currency (e.g. 2 USD pairs) allowed at once.
  # With the new balanced basket, this allows reasonable concurrency.
  max_currency_exposure: 2         
  
  # V16.21: SINGLE TRADE ENFORCEMENT
  # Set to 1 to strictly prevent "No Money" margin errors per symbol.
  max_open_trades: 1               
  max_risk_percent: 2.0 # Raised for Aggressor            
  
  # --- LEVERAGE GUARD (V16.11 SWING STANDARDS) ---
  leverage:
    default: 30.0        # Forex Majors (Standard)
    minor: 30.0          # Forex Minors (Standard)
    gold: 20.0           # XAUUSD
    indices: 20.0        # US30, SPX500
    crypto: 2.0          # BTCUSD
  
  leverage_safety_divisor: 1.5
  
  max_leverage: 30.0
  max_lot_size: 50.0 
  min_lot_size: 0.01
  
  # PROJECT PHOENIX EXIT LOGIC
  stop_loss_atr_mult: 1.5                
  take_profit_atr_mult: 3.0              
  
  # ACTIVE TRAILING STOP
  trailing_stop:
    enabled: true        
    activation_r: 1.0       # Activate earlier (1.0R)
    trail_trigger_r: 1.0       
    trail_dist_r: 0.5       # Tight Trail (0.5R) to bank scalps
  
  risk_timezone: "Europe/Prague"
  
  # --- SESSION & TIME MANAGEMENT (NEW) ---
  # Enforces trading only during London & New York sessions.
  # Hard close 3 hours before NY session end to avoid EOD wicks.
  # Based on FTMO Server Time (EET):
  # - London Open (~08:00 UK) ~= 10:00 Server
  # - NY Close (~17:00 NY) ~= 24:00 Server
  # - Liquidation Target (14:00 NY) ~= 21:00 Server
  session_control:
    enabled: true
    start_hour_server: 10      # Start Trading (London Open)
    liquidate_hour_server: 21  # Stop & Close All (3h before NY Close)
  
  # Legacy Friday settings (Reinforced by session_control)
  friday_entry_cutoff_hour: 16 # No entries after 16:00
  friday_liquidation_hour_server: 21  
  
  commission_per_lot_rt: 5.0
  contract_size: 100000
  
  max_trades_per_day: 100          
  correlation_penalty_threshold: 0.85
  max_loss_usd: 5000.0
  hard_stop_equity_usd: 80000.0
  
  # V16.23 REALITY FIX: ABSOLUTE HARD FLOOR FOR STOPS
  # Enforce 15 pips to survive the noise, especially on crosses.
  min_stop_loss_pips: 15.0

# --- TRADING PORTFOLIO (V16.30 GOLDEN BASKET) ---
trading:
  # THE GOLDEN BASKET: OPTIMAL SPREAD-TO-VOLATILITY RATIO
  # Removing High-Cost Pairs (GBPAUD/GBPNZD) to restore ML Edge.
  symbols:
    # --- MAJORS (Low Cost / High Liquidity) ---
    - "EURUSD"   # The Anchor (Spread ~1.5)
    - "GBPUSD"   # Trend King (Spread ~2.0)
    - "USDJPY"   # Carry/Trend (Spread ~1.8)
    - "AUDUSD"   # Commodity Proxy (Spread ~1.8)
    - "USDCAD"   # Mean Reversion Proxy (Spread ~2.8)
    
    # --- CROSSES (High Volatility / Reasonable Cost) ---
    - "GBPJPY"   # The Dragon (Vol compensates for ~4.5 spread)
    - "EURJPY"   # Cross Liquidity (Spread ~2.5)
    - "AUDJPY"   # Risk-On/Off Proxy (Spread ~3.0)
  
  auxiliary_symbols:
    # Pairs needed for PnL conversion but not traded actively
    - "NZDUSD"  # Keep for safety if we ever add NZD pairs back
    - "USDCHF"  # Keep for correlation calculations
    
  timeframe: "M5"
  magic_number: 621001
  slippage: 3 
  
  # --- EXECUTION OPTIMIZATION ---
  limit_order_offset_pips: 0.1 
  limit_order_ttl_seconds: 60

# --- ONLINE LEARNING ---
online_learning:
  model_type: "AdaptiveRandomForest"
  
  # CONFIGURATION (RESTORED)
  n_models: 50        
  grace_period: 200        
  delta: 0.00001        
  warning_delta: 0.001        
  lambda_value: 10        
  max_features: 'sqrt'    
  metric: "LogLoss"        
  
  burn_in_periods: 30    
  
  # Volatility Gate
  volatility_gate:
    enabled: true
    # V16.5: Lowered to 0.9 to catch early expansion
    min_atr_spread_ratio: 0.9  
  
  positive_class_weight: 1.5 
  negative_class_weight: 1.0
  
  meta_labeling_threshold: 0.55
  
  tbm:
    # HORIZON: 4 Hours (Scalper)
    horizon_minutes: 240        
    barrier_width: 2.5        
    min_profit_pips: 5.0        
    drift_threshold: 1.5 
  
  learning_horizon_sec: 300
  
  # AGGRESSOR PROTOCOL
  min_calibrated_probability: 0.00 

# --- NEWS FILTER ---
news_filter:
  enabled: true
  primary_url: "http://nfs.faireconomy.media/ff_calendar_thisweek.xml"
  backup_url: "https://www.forexfactory.com/calendar"
  buffer_minutes_before: 5   # Minimal buffer for Scalping
  buffer_minutes_after: 5    # Minimal buffer
  restricted_events:
    USD: ["FOMC", "NFP", "CPI"] 
    GBP: ["BOE", "CPI"]
    JPY: ["BOJ"]
    AUD: ["RBA", "CPI"]
    EUR: ["ECB", "CPI"]
    CAD: ["BOC", "CPI"]

# --- FORENSIC AUDIT ASSUMPTIONS ---
forensic_audit:
  enforce_spread: true
  max_slippage_pips: 2.0
  commission_per_lot: 5.0
  # V16.30: Updated assumptions based on GOLDEN BASKET (Standard FTMO Spreads)
  # Values include small safety buffer.
  spread_pips:
    default: 1.6  
    GBPJPY: 4.5    # Accepted High Spread (High Vol)
    USDJPY: 1.8    # Low
    EURJPY: 2.5    # Medium
    AUDJPY: 3.0    # Medium
    GBPUSD: 2.0    # Low
    EURUSD: 1.6    # Lowest
    AUDUSD: 1.8    # Low
    USDCAD: 2.8    # Medium
    
    # Legacy/Blacklisted (Kept for historical audit if needed)
    GBPAUD: 8.0    # AVOID
    EURAUD: 6.0    # AVOID
    GBPNZD: 9.0    # AVOID

# --- WFO OPTIMIZATION ---
wfo:
  n_trials: 100
  train_years: 2
  test_months: 6
  min_trades_optimization: 40  # Lowered from 100 to allow slower pairs to survive
  risk_per_trade_options: [0.005, 0.01] # 0.5%, 1.0% (Aggressor)