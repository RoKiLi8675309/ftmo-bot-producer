# =============================================================================
# config.yaml â€“ PROJECT PHOENIX V1.5 (HIGH CONVICTION SNIPER)
# STATUS: TUNED FOR SURVIVAL & PROFITABILITY
#
# AUDIT REMEDIATION (2025-12-26 - SNIPER MODE):
# 1. GATES TIGHTENED: Shifted from "Middle Ground" to "High Conviction".
#    - ATR: 1.2 (was 0.9) | RVol: 1.1 (was 0.9) | KER: 0.60 (was 0.50)
# 2. AGGRESSOR: Raised to 0.60 to reject "Indecision Candles" seen in logs.
# 3. RISK: Lowered to 0.25% per trade to survive learning drawdowns.
# 4. ML THRESHOLD: Raised to 0.65 to filter low-confidence noise.
# =============================================================================

# --- ENVIRONMENT SPECIFIC ---
env:
  initial_balance: 100000.0
  mode: "RESEARCH" 

# --- LOGGING CONFIGURATION ---
logging:
  level: "INFO"
  file_path: "ftmo_bot.log"
  max_size_mb: 10
  backup_count: 5
  human_friendly: true
  trade_audit_file: "trade_audit.jsonl"

# --- BROKER CONNECTION ---
mt5:
  login: null 
  password: null
  server: "FTMO-Server"
  path: "C:\\Program Files\\FTMO MetaTrader 5\\terminal64.exe"
  timeout_seconds: 5

# --- INFRASTRUCTURE ---
redis:
  host: "localhost"
  port: 6379
  db: 0
  price_data_stream: "price_data_stream"
  candle_stream_key_prefix: "stream:new_candle"
  trade_request_stream: "trade_requests"
  closed_trade_stream_key: "stream:closed_trades"
  account_info_key: "bot:account_info"
  position_state_key_prefix: "bot:positions"
  monitor_features_prefix: "monitor:features:"
  engine_state_key: 'bot:engine_state'
  
  risk_keys:
    current_equity: "risk:equity"
    daily_drawdown: "risk:daily_dd"
    open_positions: "risk:positions"
    daily_pnl: "risk:daily_pnl"
    consecutive_losses: "risk:consecutive_losses"
    last_deal_time: "risk:last_deal_time"
    pause_trading_flag: "risk:pause_trading"
    daily_starting_equity: "risk:daily_starting_equity"
    kill_switch_active: "bot:state:kill_switch_active"
    midnight_freeze: "bot:state:freeze"
    last_reset_date: "risk:last_reset_date"
    penalty_box_prefix: "risk:penalty_box:"
  
  heartbeat_key: "producer:heartbeat"

postgres:
  host: "localhost"
  port: 5432
  db: "trading_db"
  user: "postgres"
  password: "password"

# --- PRODUCER SETTINGS ---
producer:
  tick_interval_seconds: 0.1
  process_priority: "HIGH"
  midnight_freeze_seconds: 300
  d1_update_interval: 60

# --- DATA SETTINGS ---
data:
  sampling_method: "volume"
  volume_bar_threshold: 1000
  download_start_date: "2020-01-01"
  num_candles_producer: 50000
  num_candles_train: 4000000 
  num_candles_wfo: 10000
  num_candles_backtest: 200000

# --- FEATURE ENGINEERING (PROJECT PHOENIX L1 PROXIES) ---
features:
  use_causal_features: true
  n_jobs: 20
  use_cache: true
  window_size: 50
  
  # Core Inputs
  use_log_returns: true
  
  # Project Phoenix L1 Proxies
  use_parkinson_vol: true    # High/Low Volatility
  use_amihud_liquidity: true # Return / DollarVolume
  use_relative_volume: true  # Vol / SMA(Vol)
  use_aggressor_ratio: true  # Close location within High-Low
  
  # Legacy / Context
  use_regime: true
  use_vol_breakout: true
  
  # Indicator Windows
  rsi_period: 14
  macd_fast: 12
  macd_slow: 26
  macd_signal: 9
  atr_period: 14
  
  # Context Windows
  d1_ema_period: 200
  entropy_window: 100
  entropy_threshold: 0.90
  
  # Stationarity
  fractional_differentiation:
    d: 0.4
    window: 30
    
  # Regime Filter (ADX)
  adx:
    period: 14
    threshold: 25
    
  cyclical_time: true
  session_awareness: true
  cluster_context: true
  d1_context: true

# --- PHOENIX STRATEGY PARAMETERS (V1.5 HIGH CONVICTION) ---
phoenix_strategy:
  # Regime A: Volatility Expansion
  vol_expansion_threshold: 1.5  # Raised from 1.2 to filter minor pops
  
  # Regime B: Momentum Trend
  # AUDIT FIX: Raised to 0.60 (was 0.50) to ensure established trends
  ker_trend_threshold: 0.60      
  
  # Entry Gates (V1.5 TUNING)
  # AUDIT FIX: Raised to 1.2 (was 0.9) to filter chop/noise
  range_gate_atr_mult: 1.2      
  
  # AUDIT FIX: Raised to 1.1 (was 0.9) to ensure volume support
  volume_gate_ratio: 1.1        
  
  # AUDIT FIX: Raised to 0.60 to reject indecision candles (Dojos)
  aggressor_threshold: 0.60     # Close > 60% of High-Low
  
  ml_confirmation_threshold: 0.60 # Base threshold for MetaLabeler
  
  # Microstructure Filters (Proxies)
  vpin_bucket_size: 1000
  vpin_threshold: 0.90
  gate_fdi_threshold: 1.60      # Complexity filter

# --- RISK MANAGEMENT ---
risk_management:
  account_currency: "USD"
  
  # --- SIZING METHOD: STRICT PROP FIRM MODE ---
  sizing_method: "fixed_risk"
  
  # RISK PER TRADE: 0.25% of Equity (Survival Mode)
  # Lowered from 0.5% to prevent blowout strings
  base_risk_per_trade_percent: 0.25
  
  max_daily_loss_pct: 0.04
  max_total_loss_pct: 0.09
  max_risk_percent: 1.0         # Hard cap per trade
  max_leverage: 30.0
  max_lot_size: 5.0
  min_lot_size: 0.01
  
  # PROJECT PHOENIX EXIT LOGIC
  stop_loss_atr_mult: 1.5       # Standard Stop
  take_profit_atr_mult: 3.0     # Fixed 1:2 RR baseline (managed by Trail)
  
  # TRAILING STOP
  trailing_stop:
    enabled: true
    activation_atr: 1.2         # Start trailing at 1.2 ATR profit
    step_atr: 0.3               # Tighter steps to lock profit
  
  risk_timezone: "Europe/Prague"
  friday_liquidation_hour_server: 21 # 21:00 Server Time (approx 3h before close)
  
  commission_per_lot_rt: 5.0
  contract_size: 100000
  
  max_trades_per_day: 5
  correlation_penalty_threshold: 0.8
  max_loss_usd: 5000.0
  hard_stop_equity_usd: 80000.0
  min_stop_loss_pips: 3.0

# --- TRADING PORTFOLIO (AUTOCORRELATED PAIRS) ---
trading:
  symbols:
    - "GBPJPY"  # The Dragon (High Volatility)
    - "EURUSD"  # Deep Liquidity
    - "USDJPY"  # Macro Trends
    - "AUDUSD"  # Commodities Proxy
  
  # Excluded: CHF (Intervention), CAD (Choppy)
  
  auxiliary_symbols:
    - "GBPUSD"
    - "USDCAD"
    
  timeframe: "M5"
  magic_number: 621001
  slippage: 5
  
  # --- EXECUTION OPTIMIZATION ---
  # Passive Front-Running: Limit Order inside spread
  limit_order_offset_pips: 0.2 
  limit_order_ttl_seconds: 60   # Momentum is fleeting

# --- ONLINE LEARNING ---
online_learning:
  model_type: "ARFClassifier"
  
  # GOLDEN CONFIGURATION
  n_models: 30        # Range 30-50
  grace_period: 250       # Range 200-500
  delta: 0.00005          # Adaptation Rate
  warning_delta: 0.001    # Early Warning
  lambda_value: 10        # Poisson Weight
  max_features: 'log2'    # Decorrelation
  metric: "LogLoss"       # Probability Calibration
  
  burn_in_periods: 500    # Reduced from 1000 for faster start
  
  # Volatility Gate
  volatility_gate:
    enabled: true
    min_atr_spread_ratio: 1.5 
  
  positive_class_weight: 2.0
  negative_class_weight: 2.0
  
  meta_labeling_threshold: 0.55
  
  tbm:
    horizon_minutes: 60
    barrier_width: 1.5      # Volatility Multiplier
    min_profit_pips: 5.0
    drift_threshold: 1.2 
    
  learning_horizon_sec: 300
  
  # AUDIT FIX: Raised to 0.65 to ensure high conviction (was 0.60)
  min_calibrated_probability: 0.65 

# --- NEWS FILTER ---
news_filter:
  enabled: true
  primary_url: "http://nfs.faireconomy.media/ff_calendar_thisweek.xml"
  backup_url: "https://www.forexfactory.com/calendar"
  buffer_minutes_before: 30
  buffer_minutes_after: 30
  restricted_events:
    USD: ["FOMC", "NFP", "CPI", "GDP", "Rate"]
    EUR: ["ECB", "CPI", "Rate"]
    GBP: ["BOE", "CPI", "Rate"]
    JPY: ["BOJ", "Rate"]

# --- FORENSIC AUDIT ASSUMPTIONS ---
forensic_audit:
  enforce_spread: true
  max_slippage_pips: 2.0
  commission_per_lot: 5.0
  spread_pips:
    default: 1.5
    GBPUSD: 1.8
    EURUSD: 1.2
    USDJPY: 1.5
    AUDJPY: 2.0
    GBPJPY: 2.5
    XAUUSD: 30.0

# --- WFO OPTIMIZATION ---
wfo:
  n_trials: 50
  train_years: 2
  test_months: 6
  # AUDIT FIX: Reduced to 15 to account for stricter gates (was 25)
  min_trades_optimization: 15