# =============================================================================
# config.yaml â€“ FTMO COMPLIANCE MODE V28.0 (PHASE 2 REMEDIATION)
# STATUS: PHASE 2 - NON-LINEAR ADAPTIVE ENSEMBLES
# REMEDIATION AUDIT LOG (Phase 2):
# 1. ARCHITECTURE: Adaptive Random Forest (ARF) with Weighted Learning.
# 2. DATA: Recursive Streaming Indicators (RSI, MACD, ATR).
# 3. WARM-UP: Enforced 1000-candle Burn-In Period.
# 4. RISK: Volatility-Adjusted Sizing (Kelly-Vol).
# 5. IMBALANCE: Class Weights (10:1) instead of Sampling.
# =============================================================================

# --- ENVIRONMENT SPECIFIC ---
env:
  initial_balance: 100000.0 # Default balance for FTMO Challenge

# --- LOGGING CONFIGURATION ---
logging:
  level: "INFO" 
  file_path: "ftmo_bot.log"
  max_size_mb: 10
  backup_count: 5
  human_friendly: true
  trade_audit_file: "trade_audit.jsonl"

# --- BROKER CONNECTION (Windows Producer) ---
mt5:
  login: null # Set via .env (MT5_LOGIN)
  password: null # Set via .env (MT5_PASSWORD)
  server: null # Set via .env (MT5_SERVER)
  path: null # Set via .env (MT5_PATH)

# --- INFRASTRUCTURE (Redis & Postgres) ---
redis:
  host: "localhost"
  port: 6379
  db: 0
  price_data_stream: "price_data_stream"
  candle_stream_key_prefix: "stream:new_candle"
  trade_request_stream: "trade_request_stream"
  closed_trade_stream_key: "stream:closed_trades"
  account_info_key: "bot:account_info"
  position_state_key_prefix: "bot:positions"
  monitor_features_prefix: "monitor:features:"
  engine_state_key: 'bot:engine_state'
  
  risk_keys:
    daily_pnl: "risk:daily_pnl"
    consecutive_losses: "risk:consecutive_losses"
    last_deal_time: "risk:last_deal_time"
    pause_trading_flag: "risk:pause_trading"
    daily_starting_equity: "risk:daily_starting_equity"
    current_equity: "risk:current_equity"
    kill_switch_active: "bot:state:kill_switch_active"
    midnight_freeze: "bot:state:freeze"
    last_reset_date: "risk:last_reset_date"
    penalty_box_prefix: "risk:penalty_box:"
  
  heartbeat_key: "producer:heartbeat"

postgres:
  host: "localhost"
  port: 5432
  db: "trading_db"
  user: "postgres"
  password: "password"

# --- PRODUCER SETTINGS ---
producer:
  tick_interval_seconds: 0.1
  process_priority: "HIGH"
  midnight_freeze_seconds: 300
  d1_update_interval: 60

# --- DATA SETTINGS ---
data:
  sampling_method: "volume"
  volume_bar_threshold: 1000 # Adaptive thresholding logic applies in code
  download_start_date: "2020-01-01"
  num_candles_producer: 50000
  num_candles_train: 35000
  num_candles_wfo: 10000
  num_candles_backtest: 1000

# --- FEATURE ENGINEERING (Phase 2: Recursive Indicators) ---
features:
  use_causal_features: true
  n_jobs: 20
  use_cache: true
  window_size: 50 # Base window for diffs
  
  # Phase 2: Recursive Indicators Parameters
  rsi_period: 14
  macd_fast: 12
  macd_slow: 26
  macd_signal: 9
  atr_period: 14
  
  # Legacy & Context
  d1_ema_period: 200
  entropy_window: 100
  entropy_threshold: 0.70 # Moderately relaxed to allow feature learning
  ofi_alpha: 0.1
  
  fractional_differentiation:
    d: 0.3
    window: 30

  # Context Flags
  cyclical_time: true
  session_awareness: true
  cluster_context: true
  d1_context: true

# --- MICROSTRUCTURE FILTERS ---
microstructure:
  vpin_bucket_size: 1000
  vpin_threshold: 0.75
  er_threshold_noise: 0.40
  er_threshold_trend: 0.60
  hurst_threshold_mean_revert: 0.45
  hurst_threshold_random_low: 0.45
  hurst_threshold_random_high: 0.55
  hurst_threshold_trend: 0.55

# --- RISK MANAGEMENT (FTMO Kelly-Vol) ---
risk_management:
  account_currency: "USD"
  risk_timezone: "Europe/Prague"
  
  # Phase 2 Sizing: Volatility Adjusted (Risk Amount / (ATR * Value))
  sizing_method: "kelly_volatility" 
  base_risk_per_trade_percent: 0.5 # 0.5% Hard Risk (Section 5.1)
  max_leverage: 30
  commission_per_lot_rt: 5.0
  contract_size: 100000
  
  # Constraints
  max_daily_loss_pct: 0.05
  max_total_loss_pct: 0.10
  max_risk_percent: 1.0 # Cap single trade risk
  hard_stop_equity_usd: 80000.0
  max_trades_per_day: 20
  
  # Kelly Settings
  kelly_enabled: true
  kelly_fraction: 0.50
  kelly_window: 20
  
  # CPPI Cushion
  cppi_enabled: true
  cppi_floor_pct: 0.08
  cppi_multiplier: 2.0

  # Execution Guardrails
  min_lot_size: 0.01
  max_lot_size: 50.0
  min_stop_loss_pips: 2.0
  max_loss_usd: 1000.0
  
  # Adaptive Stops (Based on ATR)
  stop_loss_atr_mult: 1.0 # Section 5.2
  take_profit_atr_mult: 2.0 # Section 5.2 (Reward > Risk)

# --- TRADING PORTFOLIO ---
trading:
  symbols:
    - "EURUSD"
    - "GBPJPY"
    - "AUDCAD"
    - "EURGBP"
    - "USDCHF"
    - "AUDJPY"
  auxiliary_symbols:
    - "GBPUSD"
    - "USDCAD"
    - "USDJPY"
  timeframe: "M5" # Reference only, Volume Bars used internally
  magic_number: 621001
  slippage: 5

# --- NEWS FILTER ---
news_filter:
  enabled: false
  primary_url: "http://nfs.faireconomy.media/ff_calendar_thisweek.xml"
  backup_url: "https://www.forexfactory.com/calendar"
  buffer_minutes_before: 2
  buffer_minutes_after: 2
  restricted_events: {}

# --- WFO OPTIMIZATION ---
wfo:
  n_trials: 200
  train_years: 2
  test_months: 6
  min_trades_optimization: 30

# --- ONLINE LEARNING (Phase 2: ARF + Weighted Learning) ---
online_learning:
  model_type: "ARFClassifier"
  n_models: 20 # Reduced from 40 for faster adaptation (Section 6, Step 3)
  
  # Warm-up (Section 3.2)
  burn_in_periods: 1000 # Minimum candles before training/trading
  
  # Drift & Adaptation
  grace_period: 50 # Increased from 15 to allow stable tree growth (Section 6, Step 3)
  delta: 0.01
  
  # Weighted Learning (Section 3.3)
  positive_class_weight: 10.0 # Weight for 'BUY' signals
  negative_class_weight: 1.0  # Weight for 'HOLD'/'LOSS' signals
  
  # Meta Labeling
  meta_labeling_threshold: 0.60
  
  # Optimization
  metric: "Precision" # Changed to Precision per Section 6 Step 3 code
  max_features: 'log2'
  lambda_value: 6
  
  learning_horizon_sec: 300
  min_calibrated_probability: 0.75 

  # TBM (Adaptive)
  tbm:
    horizon_minutes: 60 # 12 candles on M5 (Section 6, Step 4)
    barrier_width: 2.0 # Multiplier for ATR (TP)
    min_profit_pips: 2.0

# --- FORENSIC AUDIT ---
forensic_audit:
  enforce_spread: true
  spread_pips:
    default: 1.5
    GBPJPY: 2.5
    AUDJPY: 2.0
    EURGBP: 1.8
  max_slippage_pips: 2.0
  commission_per_lot: 5.0